<!doctype html>
<html>
  <head><title>Ancient World Digital Library</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!--[if lte IE 9]>
	<script>
		window.location.replace("http://localhost:8000/awdl_site/upgrade.html");
	</script>
<![endif]-->


<link href='http://fonts.googleapis.com/css?family=Lora:400,700|Open+Sans:400,300,600' rel='stylesheet' type='text/css'>
<link rel="shortcut icon" href="http://localhost:8000/awdl_site/images/favicon.ico" />
<link href='http://localhost:8000/awdl_site/css/style.css' rel='stylesheet' type='text/css'>
<script src="http://yui.yahooapis.com/3.15.0/build/yui/yui-min.js"></script>
</head>
  <body data-app="http://localhost:8000/awdl_site" data-appRoot="/awdl_site" data-source-discovery="http://dev-discovery.dlib.nyu.edu:8080/solr3_discovery/core0/select/"  class="subjects">
    <div class="header-wrapper ">
    	<header class="header-main container-fluid" role="banner">
    		<h1 class="sitename"><a href="http://localhost:8000/awdl_site/">Ancient World Digital Library</a></h1>
    	</header>
    </div>
    <nav class="navbar navbar-default" role="navigation">
      <div class="container-fluid"> 
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed widget" data-toggle="collapse" data-name="navButton" data-script='{ "js" : [ "navButton.min.js" ] }'> 
                 <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:a="http://ns.adobe.com/AdobeSVGViewerExtensions/3.0/" x="0px" y="0px" width="40px" height="30px" viewBox="0 0 40 30" overflow="visible" xml:space="preserve">
                   <defs> </defs>
                   <rect y="0" fill="#FFFFFF" width="40" height="3"></rect>
                   <rect y="7" fill="#FFFFFF" width="40" height="3"></rect>
                   <rect y="14" fill="#FFFFFF" width="40" height="3"></rect>
                 </svg> 
                 <span class="sr-only">Toggle navigation</span> 
         </button>
         <script>/*! awdl-site 2015-04-02 */
         YUI().use("node","event","anim",function(a){"use strict";function b(a){a.preventDefault(),c.fx.set("reverse",!c.fx.get("reverse")),c.fx.run()}var c=a.one(".navbar-collapse").plug(a.Plugin.NodeFX,{from:{height:function(a){return a.get("scrollHeight")}},to:{height:0},easing:a.Easing.easeBoth,on:{end:function(){var b=a.one(".navbar-toggle");b.toggleClass("collapsed")}},duration:.3});a.one("body").delegate("click",b,".navbar-toggle")});</script>    </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="navbar-collapse" >
          <ul class="nav navbar-nav">
              <li><a href="http://localhost:8000/awdl_site" class="front">Home</a></li>
              <li><a href="http://localhost:8000/awdl_site/about" class="about">About</a></li>
              <li><a href="http://localhost:8000/awdl_site/series" class="series">Series</a></li>
              <li><a href="http://localhost:8000/awdl_site/subjects" class="subjects">Subjects</a></li>
              <li><a href="http://localhost:8000/awdl_site/browse" class="browse">Browse</a></li>
          </ul>
          <div class="search_holder widget navbar-form navbar-right" data-name="search_form" data-script='{ "js" : [ "search_form.min.js" ] }'>
    	<form method="get" action="http://localhost:8000/awdl_site/search" role="search">
    		<input type="submit" class="submit-search">
    		<input name="q" type="text" placeholder="search" title="Enter the terms you wish to search for.">
    	</form>
    </div><script>/*! awdl-site 2015-04-02 */
    YUI().use("node","event",function(a){"use strict";function b(a){a.preventDefault();var b=a.currentTarget,c=b.one('[type="text"]'),d=c.get("value");d.length&&(location.href=b.get("action")+"?q="+d.trim().replace(/\s/g,"+"))}var c=a.one("body");c.delegate("submit",b,"form")});</script> </div>
        <!-- /.navbar-collapse --> 
      </div>
      <!-- /.container-fluid --> 
    </nav>	<main class="main container-fluid" role="main" data-tid="177">
	  <header>
	    <h2>Astronomy</h2>
        <div class="resultsnum">Showing  <span class="start"></span> - <span class="docslength"></span> of <span class="numfound"></span> results</div>
        <select id="browse-select">
          <option data-sort-dir="desc" value="score" selected>Sorting by Relevance</option>
          <option data-sort-dir="asc" value="iass_longlabel">Sort by Title</option>
          <option data-sort-dir="asc" value="ss_sauthor">Sort by Author</option>
        </select>
	  </header>
	  <div>
          <div 
            class="widget" 
            data-name="items" 
            data-rows="12"
            data-source=""
            data-fl="zs_image_medium,ss_identifer,ss_title,sm_author,sm_publisher,ss_spublisher,ss_pubdate,sm_partner,sm_subject,ss_publocation,sm_field_publication_location,is_ispartof_series,ss_series_label,is_ispartof_multivol,ss_multivol_label"
              data-fq-sm_collection_identifier="d72398c3-1cd7-4734-ab1c-3e3b29862cee"
            data-fq-im_field_subject="177"
            data-script='{ "js" : [ "subjects_page.js" ], "hbs" : [ { "template" : "items.hbs", "id" : "items" } ] }'
          ></div>
          <div class="text-center">
            <div id="paginator" class="pagination"></div>
          </div>        
	  </div>
    </main>
    <div class="footer-wrapper">
    <footer class="footer-main container-fluid" role="contentinfo">
    	<div class="logo"><a href="http://nyu.edu/" target="_blank"><img src="http://localhost:8000/awdl_site/images/nyu_short_white.svg" alt="NYU" width="120" height="41"></a></div>
      <div class="partner-wrapper">
          <div class="partner-isaw">
          	<a href="http://isaw.nyu.edu/" title="INSTITUTE FOR THE STUDY OF THE ANCIENT WORLD" target="_blank">INSTITUTE FOR THE STUDY OF THE ANCIENT WORLD</a></div>
          <div class="partner-dlts">
          	<a href="http://dlib.nyu.edu/" title="DIGITAL LIBRARY TECHNOLOGY SERVICES" target="_blank">DIGITAL LIBRARY TECHNOLOGY SERVICES</a></div>
      </div></footer>
    </div>    <script id="items" type="text/x-handlebars-template"><!-- file: items.hbs -->
<div class="item-list flex-container">
  {{#items}}
  <article class="item" {{#if score}}data-score="{{{score}}}"{{/if}}>
  <div class="card">
    <div class="thumbs" >
      <div class="clipper">
      <a href="{{../app.appRoot}}/book/{{ss_identifer}}"><img src="{{zs_image_220wide}}" alt="" title="{{title}}"/></a></div>
    </div>
    <h1 class="md_title"><a href="{{../app.appRoot}}/book/{{ss_identifer}}">{{{ss_title}}}</a></h1>
    <div class="md_author">{{#each sm_author}}<span>{{this}}</span>{{/each}}</div>
    {{#if is_ispartof_series}}
      <div class="md_series"><span class="md_label">Series</span> <span>{{ss_series_label}}</span></div>
    {{/if}}
    {{#if is_ispartof_multivol}}
      <div class="md_multivol"><span class="md_label">Part of</span> <span>{{ss_multivol_label}}</span></div>
    {{/if}}
    <div  class="md_publisher"><span class="md_label">Publisher:</span> {{#each sm_publisher}}<span>{{this}}</span>{{/each}}, {{#each sm_field_publication_location}}<span>{{this}}</span>{{/each}}, {{ss_pubdate}}</div>
    <div class="md_provider"><span class="md_label">Provider:</span> {{#each sm_partner}}<span>{{this}}</span>{{/each}}</div>
    <div class="md_subjects"><span class="md_label">Subjects:</span> {{#each sm_subject}}<a class="md_subject" href="{{../../app.appRoot}}/search?q={{this}}">{{this}}</a>{{/each}}</div>
  </div>
  </article>
  {{/items}}
  <article class="item"></article>
  <article class="item"></article>
</div>
</script><script>/* jshint laxcomma: true */
YUI().use(
    'node'
  , 'event'
  , 'handlebars'
  , 'jsonp'
  , 'router'
  , 'gallery-paginator'
  , 'anim'
  , function (Y) {
  
    'use strict';
    
    var itemsTemplateSource = Y.one('#items').getHTML();
    
    var itemsTemplate = Y.Handlebars.compile(itemsTemplateSource);
    
    var router = new Y.Router();
  
    function getRoute () {

      var pageQueryString = getParameterByName('page')
        , sortQueryString = getParameterByName('sort')
        , page = ( pageQueryString ) ? pageQueryString : 1
        , route = router.getPath() + '?page=' + page;

      if ( sortQueryString ) {
          route = route + '&sort=' + sortQueryString;
      }
      
      return route;

    }

    function getRouteChangedParameters () {

      // when filter or sort is changed, we should go back to the first page
      var sortQueryString = getParameterByName('sort')
        , route = router.getPath();

      if ( sortQueryString ) {
          route = route + '&sort=' + sortQueryString;
      }
  
      return route;

    }
    
    function getParameterByName(name) {
      
      name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
      
      var regex = new RegExp("[\\?&]" + name + "=([^&#]*)")
        , results = regex.exec(location.search);

      return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }

    router.route( router.getPath(), function ( req ) {

      var node = Y.one('[data-name="items"]')
        , data = node.getData()
        , rows = ( req.query.rows ) ? req.query.rows : ( ( data.rows ) ? data.rows : 10 ) 
        , sort = ( req.query.sort ) ? req.query.sort : ( ( data.sort ) ? data.sort : Y.one('#browse-select').get('value') )           
        , page = ( req.query.page ) ? parseInt( req.query.page, 10 ) : 0
        , start =  0;

        if ( page <= 1 ) {
          start = 0;
        }
        else {
          start = ( page * rows ) - rows;
        }
      
      initRequest ( {
        container : node
        , start : start
        , page : page
        , rows : rows
        , sort : sort
      } );
      
    });
  
  function onSelectChange( ) {
    
    
    Y.all('#browse-select option').each(function(node) { 
      /* reset all option text */ 
      var t = node.get("text");
      t = t.replace("Sorting by", "Sort by");
      node.set("text", t);
    });
    var t2 = Y.one("#browse-select option:checked").get("text");
    t2 = t2.replace("Sort by", "Sorting by");
    Y.one("#browse-select option:checked").set("text", t2);
    
    router.replace( getRouteChangedParameters() );
   
  }
  
  function onFailure( response, args ) {
    
      // mover a onFailure
      var data = args.container.getData()
        , requestError = data.requesterror;
        
      if ( !requestError ) {
          args.container.setAttribute( 'data-requesterror', 1 );
          requestError = 1;
      }
      else { 
          requestError = parseInt(requestError, 10) + 1;
          args.container.setAttribute( 'data-requesterror', requestError );                
      }
    
      /** there try 3 more times before giving up */
      if ( requestError < 3 ) {
          router.replace( getRoute () );
      }
      else {
        Y.log('onFailure: there was a problem with this request');
      }
  }

  function onTimeout() {
      onFailure();
  }
  
  function update ( state ) {

    this.setPage( state.page, true );
    this.setRowsPerPage( state.rowsPerPage, true );
    this.setTotalRecords( state.totalRecords, true );
    router.save( router.getPath() + '?page=' + state.page );

  }
  
  function initPaginator( page, totalRecords, rowsPerPage ) {
      
      Y.one('#paginator').empty();
      var paginatorConfiguration = {
              totalRecords: totalRecords
            , rowsPerPage: rowsPerPage
            , initialPage : page
            , template: '{FirstPageLink} {PageLinks} {NextPageLink}'        
          }
        , paginator = new Y.Paginator( paginatorConfiguration );

      paginator.on( 'changeRequest', update );
        
      if (totalRecords > rowsPerPage) {
        paginator.render('#paginator');
      }

  }    

  function onSuccess ( response, args ) {
      
      try {
          
          var node = args.container
            , resultsnum = Y.one('.resultsnum')
            , page = ( args.page ) ? args.page : 1
            , numfound = parseInt(response.response.numFound, 10)
            , numfoundNode = resultsnum.one('.numfound')
            , start = parseInt(response.response.start, 10)
            , displayStart = ( start < 1 ) ? 1 : (start + 1)
            , startNode = resultsnum.one('.start')
            , docslengthNode = resultsnum.one('.docslength')
            , docslength = parseInt(response.response.docs.length, 10)
            , appRoot = Y.one('body').getAttribute('data-app')
            , rows = args.rows
            ;
 
          /** re-init pagination each time, since number of results changes */
          initPaginator( page , numfound, rows );

          node.setAttribute( 'data-numFound', numfound );

          node.setAttribute( 'data-start', start );

          node.setAttribute( 'data-docsLength', docslength );
          
          startNode.set( 'innerHTML', displayStart );

          docslengthNode.set( 'innerHTML', start + docslength );
          
          numfoundNode.set( 'innerHTML', numfound );

          node.append(
            itemsTemplate({
              items : response.response.docs,
              app: { appRoot : appRoot }
            })
          );
          
          args.container.setAttribute( 'data-requesterror', 0 );

          Y.one('body').removeClass('io-loading');

      }

      catch (e) { }

  }

  function initRequest ( options ) {
  
      var start = 0
        , page = 0
        , sortData = Y.one('#browse-select :checked')
        , sortBy = sortData.get('value')
        , sortDir = sortData.getAttribute( "data-sort-dir" )
        , data = options.container.getData()
        , source = Y.one('body').getAttribute('data-source-discovery')
        , subject_term_id = Y.one('main').getAttribute('data-tid')
        , fl = ( data.fl ) ? data.fl : '*'
        , rows = ( data.rows ) ? data.rows : 10
        , fq = [];
      
      Y.log ( subject_term_id ) ;

      Y.one('body').addClass('io-loading');
      
      /** find all data-fq and push the value into fq Array*/
      for ( var prop in data ) {
          if ( data.hasOwnProperty( prop ) ) {
              if ( prop.match('fq-') ) {
                fq.push( prop.replace('fq-', '') + ':' + data[prop] );
            }
          }
      }
         
      if ( options.page ) {
          page = parseInt( options.page, 10 );
      }

      if ( options.start ) {
          start = parseInt( options.start, 10 );
      }

      if ( options.rows ) {
          rows = parseInt( options.rows, 10 );
      }
      
      source = source 
             + "?"
             + "wt=json"
             + "&json.wrf=callback={callback}"
             + "&fl=" + fl
             + "&fq=" + fq.join("&fq=")
             + "&rows=" + rows
             + "&start=" + start
             + "&sort=" + sortBy + "%20" + sortDir;

      options.container.empty();

      Y.jsonp( source, {
          on: {
              success: onSuccess,
              failure: onFailure,
              timeout: onTimeout
          },
          args: options,
          timeout: 3000
      });
  
  }
  
  router.replace( getRoute () );
  
});
</script>
  </body>
</html>
